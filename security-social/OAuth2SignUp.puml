@startuml

browser --> browser: OAuth2登录注册流程开始

browser -> SocialAuthenticationFilter: 1 跳转到 /Authentication/social

SocialAuthenticationFilter -> SocialAuthenticationSignUpFilter: 1.1 doFilter()
SocialAuthenticationSignUpFilter --> SocialAuthenticationSignUpFilter: 1.2 attemptAuthService()
SocialAuthenticationSignUpFilter -> ProviderManager: 1.2.1 authenticate(authRequest)
ProviderManager -> SocialAuthenticationSignUpProvider: 1.2.1.1 authenticate(token)
SocialAuthenticationSignUpProvider --> SocialAuthenticationSignUpProvider: 1.2.1.1.1 authenticate(token)
SocialAuthenticationSignUpProvider -> SocialOAuth2AuthenticationService: 1.2.1.1.1.1 user=loadUserByUserId(id)

SocialOAuth2AuthenticationService --> SocialAuthenticationSignUpProvider: 1.2.1.1.2 user!=null
SocialAuthenticationSignUpProvider --> ProviderManager: 1.2.1.2 抛出 RegisterUserFailureException("Username used")
ProviderManager --> SocialAuthenticationSignUpFilter: 1.2.2 抛出 RegisterUserFailureException("Username used")
SocialAuthenticationSignUpFilter --> SocialAuthenticationSignUpFilter: 1.2.2 抛出 RegisterUserFailureException("Username used")
SocialAuthenticationSignUpFilter -> SocialAuthenticationFailureHandler: 1.3: 抛出 RegisterUserFailureException("Username used")
SocialAuthenticationFailureHandler --> browser: 1.4: 根据LoginType类型返回 JSON 或 HTML 格式的错误信息

SocialOAuth2AuthenticationService --> SocialAuthenticationSignUpProvider: 1.2.1.1.2 user=null
SocialAuthenticationSignUpProvider -> SocialOAuth2AuthenticationService: 1.2.1.1.2.1 user=registerUser()
SocialOAuth2AuthenticationService -> ProviderSignInUtils: 1.2.1.1.2.1.1 doPostSignUp()
ProviderSignInUtils -> OAuthJdbcUsersConnectionRepository: 1.2.1.1.2.1.1.1 addConnection()
OAuthJdbcUsersConnectionRepository --> ProviderSignInUtils: 1.2.1.1.2.1.2 返回
ProviderSignInUtils --> SocialOAuth2AuthenticationService: 1.2.1.1.2.2 返回
SocialOAuth2AuthenticationService --> SocialAuthenticationSignUpProvider: 1.2.1.1.3 返回user
SocialOAuth2AuthenticationService --> ProviderManager: 1.2.1.3 返回user
ProviderManager --> SocialAuthenticationSignUpFilter: 1.2.3 返回user
SocialAuthenticationSignUpFilter --> browser: 1.5 注册成功能，返回 RedirectUrl 或 DefaultSuccessUrl



browser --> browser: OAuth2登录注册流程结束

@enduml