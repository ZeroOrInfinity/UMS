@startuml

browser --> browser: 密码登录图片验证码校验流程开始

browser -> ValidateCodeFilter: /authentication/form

ValidateCodeFilter --> ValidateCodeFilter: 1. doFilterInternal(), 验证码逻辑
ValidateCodeFilter -> ValidateCodeType: 1.1 getValidateCodeType(), 如图片与短信都适用此 uri，
ValidateCodeType --> ValidateCodeFilter: ValidateCodeType, 优先使用短信验证码逻辑
ValidateCodeFilter -> AbstractValidateCodeProcessor: 1.2 findValidateCodeProcessor(ValidateCodeType)

AbstractValidateCodeProcessor --> AbstractValidateCodeProcessor: 1.3 validate(request)
AbstractValidateCodeProcessor --> AbstractValidateCodeProcessor: 1.3.1 从 session 获取验证码
AbstractValidateCodeProcessor --> AbstractValidateCodeProcessor: 1.3.2 从 request 获取验证码
AbstractValidateCodeProcessor --> ValidateCodeFilter: 1.3.3 如校验成功，删除 session中的验证码

AbstractValidateCodeProcessor --> ValidateCodeFilter: 1.3.3 校验失败，抛出 ValidateCodeException
ValidateCodeFilter -> BrowserAuthenticationFailureHandler: 1.4 校验失败，抛出 ValidateCodeException
BrowserAuthenticationFailureHandler --> browser: 1.4.1 onAuthenticationFailure()根据设置的 LoginType 返回 JSON 或者 HTML 格式

ValidateCodeFilter -> UsernamePasswordAuthenticationFilter: 1.4.2 校验成功. doFilter()
UsernamePasswordAuthenticationFilter --> UsernamePasswordAuthenticationFilter: 1.4.2.1 attemptAuthentication()
UsernamePasswordAuthenticationFilter --> UsernamePasswordAuthenticationFilter: 1.4.2.1.1 new UsernamePasswordAuthenticationToken()
UsernamePasswordAuthenticationFilter -> AuthenticationManager: 1.4.2.1.2 authenticate(token)

AuthenticationManager -> DaoAuthenticationProvider: 1.4.2.1.2.1 getProvider
DaoAuthenticationProvider --> DaoAuthenticationProvider: 1.4.2.1.2.2 authenticate(token)
DaoAuthenticationProvider --> DaoAuthenticationProvider: 1.4.2.1.2.2.1 retrieveUser()
DaoAuthenticationProvider -> UserDetailsService: 1.4.2.1.2.2.1.1 getUserDetailsService()

UserDetailsService --> UserDetailsService: 1.4.2.1.2.2.1.2 loadUserByUsername(username)
UserDetailsService --> DaoAuthenticationProvider: 1.4.2.1.2.2.1.2 校验成功，返回 user
DaoAuthenticationProvider --> AuthenticationManager: 1.4.2.1.2.2 校验成功，返回 Authentication

AuthenticationManager --> UsernamePasswordAuthenticationFilter: 1.4.2.1.3 校验成功，返回 Authentication
UsernamePasswordAuthenticationFilter --> ValidateCodeFilter: 1.4.3 校验成功，返回 Authentication

ValidateCodeFilter --> browser: 1.4.4.1 返回 RedirectUrl 或 DefaultSuccessUrl

UserDetailsService --> DaoAuthenticationProvider: 1.4.2.1.2.2.1.3 校验失败，抛出异常
DaoAuthenticationProvider --> AuthenticationManager: 1.4.2.1.2.2 校验失败，抛出异常

AuthenticationManager --> UsernamePasswordAuthenticationFilter: 1.4.2.1.3 校验失败，抛出异常
UsernamePasswordAuthenticationFilter --> ValidateCodeFilter: 1.4.3 校验失败，抛出异常
ValidateCodeFilter -> BrowserAuthenticationFailureHandler: 1.4.4 转交BrowserAuthenticationFailureHandler处理
BrowserAuthenticationFailureHandler --> browser: 1.4.4.2 返回 login.html

browser --> browser: 密码登录图片验证码校验流程结束

@enduml