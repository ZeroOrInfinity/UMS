@startuml

browser --> browser: 密码登录图片验证码校验流程开始

browser -> ValidateCodeFilter: /authentication/form

ValidateCodeFilter --> ValidateCodeFilter: 1. doFilterInternal(),\n 验证码逻辑
ValidateCodeFilter -> ValidateCodeType: 1.1 getValidateCodeType(),\n 如图片与短信都适用此 uri，
ValidateCodeType --> ValidateCodeFilter: ValidateCodeType,\n 优先使用短信验证码逻辑
ValidateCodeFilter -> AbstractValidateCodeProcessor: 1.2 findValidateCodeProcessor\n(ValidateCodeType)

AbstractValidateCodeProcessor --> AbstractValidateCodeProcessor: 1.3 validate(request)
AbstractValidateCodeProcessor --> AbstractValidateCodeProcessor: 1.3.1 从 session\n 获取验证码
AbstractValidateCodeProcessor --> AbstractValidateCodeProcessor: 1.3.2 从 request\n 获取验证码
AbstractValidateCodeProcessor --> ValidateCodeFilter: 1.3.3 如校验成功，\n删除 session中的验证码

AbstractValidateCodeProcessor --> ValidateCodeFilter: 1.3.3 校验失败，抛出\n ValidateCodeException
ValidateCodeFilter -> BrowserAuthenticationFailureHandler: 1.4 校验失败，抛出\n ValidateCodeException
BrowserAuthenticationFailureHandler --> browser: 1.4.1 onAuthenticationFailure()\n根据设置的 LoginType \n返回 JSON 或者 HTML 格式

ValidateCodeFilter -> UsernamePasswordAuthenticationFilter: 1.4.2 校验成功.\n doFilter()
UsernamePasswordAuthenticationFilter --> UsernamePasswordAuthenticationFilter: 1.4.2.1\n attemptAuthentication()
UsernamePasswordAuthenticationFilter --> UsernamePasswordAuthenticationFilter: 1.4.2.1.1 \n UsernamePasswordAuthenticationToken()
UsernamePasswordAuthenticationFilter -> AuthenticationManager: 1.4.2.1.2\n authenticate(token)

AuthenticationManager -> DaoAuthenticationProvider: 1.4.2.1.2.1\n getProvider
DaoAuthenticationProvider --> DaoAuthenticationProvider: 1.4.2.1.2.2\n authenticate(token)
DaoAuthenticationProvider --> DaoAuthenticationProvider: 1.4.2.1.2.2.1\n retrieveUser()
DaoAuthenticationProvider -> UserDetailsService: 1.4.2.1.2.2.1.1\n getUserDetailsService()

UserDetailsService --> UserDetailsService: 1.4.2.1.2.2.1.2\n loadUserByUsername(username)
UserDetailsService --> DaoAuthenticationProvider: 1.4.2.1.2.2.1.2\n 校验成功，返回 user
DaoAuthenticationProvider --> AuthenticationManager: 1.4.2.1.2.2\n 校验成功，返回 Authentication

AuthenticationManager --> UsernamePasswordAuthenticationFilter: 1.4.2.1.3 校验成功，\n返回 Authentication
UsernamePasswordAuthenticationFilter --> ValidateCodeFilter: 1.4.3 校验成功，\n返回 Authentication

ValidateCodeFilter --> browser: 1.4.4.1 返回 RedirectUrl\n 或 DefaultSuccessUrl

UserDetailsService --> DaoAuthenticationProvider: 1.4.2.1.2.2.1.3\n 校验失败，抛出异常
DaoAuthenticationProvider --> AuthenticationManager: 1.4.2.1.2.2\n 校验失败，抛出异常

AuthenticationManager --> UsernamePasswordAuthenticationFilter: 1.4.2.1.3\n 校验失败，抛出异常
UsernamePasswordAuthenticationFilter --> ValidateCodeFilter: 1.4.3\n 校验失败，抛出异常
ValidateCodeFilter -> BrowserAuthenticationFailureHandler: 1.4.4 转交\nBrowserAuthenticationFailureHandler\n处理
BrowserAuthenticationFailureHandler --> browser: 1.4.4.2 返回 login.html

browser --> browser: 密码登录图片验证码校验流程结束

@enduml